{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-7">
    <div class="row g-2">
      <form method="post" action="{% url 'reorder_listing_images' listing.id %}">
        {% csrf_token %}
        <input type="hidden" name="order" id="order-input">
        <div id="gallery" class="row g-2">
          {% for img in listing.images.all %}
            <div class="col-6 col-md-4" draggable="true" data-id="{{ img.id }}">
              <div style="position:relative;">
                <img src="{{ img.image.url }}" class="img-fluid rounded" alt="{{ listing.title }}" style="object-fit:cover;height:200px;width:100%;">
                {% if user.is_authenticated and user == listing.host %}
                  <a href="{% url 'delete_listing_image' listing.id img.id %}"
                     onclick="return confirm('Delete this image?')"
                     class="btn btn-sm btn-danger"
                     title="Delete"
                     style="position:absolute; top:6px; right:6px; border-radius:50%; padding:6px; display:flex; align-items:center; justify-content:center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                      <path d="M10 11v6"/>
                      <path d="M14 11v6"/>
                      <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                    </svg>
                  </a>
                {% endif %}
              </div>
            </div>
          {% empty %}
            {% if listing.image %}
              <img src="{{ listing.image.url }}" class="img-fluid rounded" alt="{{ listing.title }}">
            {% elif listing.image_url %}
              <img src="{{ listing.image_url }}" class="img-fluid rounded" alt="{{ listing.title }}">
            {% endif %}
          {% endfor %}
        </div>
        {% if user.is_authenticated and user == listing.host and listing.images.all %}
        <button class="btn btn-outline-secondary mt-2">Save order (first becomes cover)</button>
        {% endif %}
      </form>
    </div>
    <h2 class="mt-3">{{ listing.title }}</h2>
    <p class="text-muted">{{ listing.city }} â€” {{ listing.address }}</p>
    <p>{{ listing.description }}</p>
    <p class="fw-bold">EGP {{ listing.price_per_night }} / night</p>
  </div>
  <div class="col-lg-5">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Request to book</h5>
        <form method="post">
          {% csrf_token %}
          {{ form.as_p }}
          <button class="btn btn-success w-100">Send request</button>
        </form>
        {% if user.is_authenticated and user == listing.host %}
        <hr>
        <h6 class="mt-3">Add photos (drag and drop)</h6>
        <form method="post" action="{% url 'upload_listing_images' listing.id %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="border rounded p-3 text-center" style="background:#fafafa;">
            <input type="file" name="images" id="image-input" class="form-control" accept="image/*" multiple>
            <small class="text-muted">Up to 10 images per upload.</small>
          </div>
          <button class="btn btn-outline-primary mt-2 w-100">Upload</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  const gallery = document.getElementById('gallery');
  const orderInput = document.getElementById('order-input');
  if (gallery) {
    let dragSrc;
    gallery.addEventListener('dragstart', (e) => {
      const card = e.target.closest('[data-id]');
      if (!card) return;
      dragSrc = card;
      e.dataTransfer.effectAllowed = 'move';
    });
    gallery.addEventListener('dragover', (e) => {
      e.preventDefault();
      const over = e.target.closest('[data-id]');
      if (!over || over === dragSrc) return;
      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) / (rect.bottom - rect.top) < 0.5;
      gallery.insertBefore(dragSrc, before ? over : over.nextSibling);
    });
    const serialize = () => Array.from(gallery.querySelectorAll('[data-id]')).map(el => el.dataset.id).join(',');
    gallery.addEventListener('drop', (e) => {
      e.preventDefault();
      orderInput.value = serialize();
    });
    // initialize order on load
    orderInput.value = serialize();
  }
</script>
{% endblock %}
